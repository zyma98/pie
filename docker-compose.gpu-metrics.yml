# DCGM GPU Metrics Exporter for SigNoz
#
# Usage:
#   docker compose -f docker-compose.gpu-metrics.yml up -d
#
# Metrics endpoint: http://localhost:9400/metrics
# SigNoz will scrape this automatically via OpenTelemetry collector.

services:
  dcgm-exporter:
    image: nvidia/dcgm-exporter:3.3.5-3.4.0-ubuntu22.04
    container_name: dcgm-exporter
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    ports:
      - "9400:9400"
    environment:
      # Collect comprehensive metrics
      - DCGM_EXPORTER_INTERVAL=1000  # 1 second interval
    volumes:
      # Custom metrics config (optional)
      - ./dcgm-custom-metrics.csv:/etc/dcgm-exporter/dcp-metrics-included.csv:ro
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9400/metrics"]
      interval: 30s
      timeout: 10s
      retries: 3

# Note: The SigNoz OTel collector needs to be configured to scrape this endpoint.
# Add the following to your SigNoz otel-collector-config.yaml:
#
# receivers:
#   prometheus:
#     config:
#       scrape_configs:
#         - job_name: 'dcgm-exporter'
#           static_configs:
#             - targets: ['dcgm-exporter:9400']
