name: Release PyPI Package

on:
  workflow_dispatch:
    inputs:
      package:
        description: 'Package to release'
        required: true
        type: choice
        options:
          - pie-server (control/)
          - pie-client (client/python/)
          - pie-backend (runtime-backend/)
          - pie-bakery (sdk/tools/bakery/)
      dry_run:
        description: 'Dry run (build but do not publish)'
        required: false
        type: boolean
        default: false

permissions:
  contents: read

env:
  PACKAGE_PATHS: |
    {
      "pie-server (control/)": "control",
      "pie-client (client/python/)": "client/python",
      "pie-client-cli (client/cli/)": "client/cli",
      "pie-backend (runtime-backend/)": "runtime-backend",
      "pie-bakery (sdk/tools/bakery/)": "sdk/tools/bakery"
    }

jobs:
  # Determine package path and type
  setup:
    runs-on: ubuntu-latest
    outputs:
      package_path: ${{ steps.info.outputs.path }}
      is_maturin: ${{ steps.info.outputs.is_maturin }}
    steps:
      - name: Extract package info
        id: info
        run: |
          case "${{ inputs.package }}" in
            "pie-server (control/)")
              echo "path=control" >> $GITHUB_OUTPUT
              echo "is_maturin=true" >> $GITHUB_OUTPUT
              ;;
            "pie-client (client/python/)")
              echo "path=client/python" >> $GITHUB_OUTPUT
              echo "is_maturin=false" >> $GITHUB_OUTPUT
              ;;
            "pie-backend (runtime-backend/)")
              echo "path=runtime-backend" >> $GITHUB_OUTPUT
              echo "is_maturin=false" >> $GITHUB_OUTPUT
              ;;
            "pie-bakery (sdk/tools/bakery/)")
              echo "path=sdk/tools/bakery" >> $GITHUB_OUTPUT
              echo "is_maturin=false" >> $GITHUB_OUTPUT
              ;;
          esac

  # Build maturin wheels for multiple platforms (only for pie-server)
  build-maturin-linux:
    needs: setup
    if: needs.setup.outputs.is_maturin == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target: [x86_64, aarch64]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist -m ${{ needs.setup.outputs.package_path }}/pyproject.toml
          manylinux: auto
      - uses: actions/upload-artifact@v4
        with:
          name: wheels-linux-${{ matrix.target }}
          path: dist

  build-maturin-macos:
    needs: setup
    if: needs.setup.outputs.is_maturin == 'true'
    runs-on: macos-latest
    strategy:
      matrix:
        target: [x86_64, aarch64]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}-apple-darwin
          args: --release --out dist -m ${{ needs.setup.outputs.package_path }}/pyproject.toml
      - uses: actions/upload-artifact@v4
        with:
          name: wheels-macos-${{ matrix.target }}
          path: dist

  build-maturin-windows:
    needs: setup
    if: needs.setup.outputs.is_maturin == 'true'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          args: --release --out dist -m ${{ needs.setup.outputs.package_path }}/pyproject.toml
      - uses: actions/upload-artifact@v4
        with:
          name: wheels-windows
          path: dist

  build-maturin-sdist:
    needs: setup
    if: needs.setup.outputs.is_maturin == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build sdist
        uses: PyO3/maturin-action@v1
        with:
          command: sdist
          args: --out dist -m ${{ needs.setup.outputs.package_path }}/pyproject.toml
      - uses: actions/upload-artifact@v4
        with:
          name: wheels-sdist
          path: dist

  # Build pure Python packages
  build-python:
    needs: setup
    if: needs.setup.outputs.is_maturin == 'false'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install build tools
        run: pip install build
      - name: Build package
        run: python -m build ${{ needs.setup.outputs.package_path }}
      - uses: actions/upload-artifact@v4
        with:
          name: wheels-python
          path: ${{ needs.setup.outputs.package_path }}/dist

  # Publish maturin package
  publish-maturin:
    name: Publish to PyPI (maturin)
    runs-on: ubuntu-latest
    needs: [setup, build-maturin-linux, build-maturin-macos, build-maturin-windows, build-maturin-sdist]
    if: needs.setup.outputs.is_maturin == 'true' && inputs.dry_run == false
    environment: pypi
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          merge-multiple: true
          path: dist
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}

  # Publish pure Python package
  publish-python:
    name: Publish to PyPI (pure Python)
    runs-on: ubuntu-latest
    needs: [setup, build-python]
    if: needs.setup.outputs.is_maturin == 'false' && inputs.dry_run == false
    environment: pypi
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: wheels-python
          path: dist
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
